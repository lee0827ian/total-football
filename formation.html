<!DOCTYPE html>
<html lang="ko">
<head>
    // ...existing code...
</head>
<body>
    <div class="header">
        <h1>⚽ 포메이션 편집기</h1>
        <div class="controls">
            <button onclick="location.href='index.html'">← 메인으로</button>
            <button onclick="resetFormation()">🔄 초기화</button>
            <button onclick="saveFormation()">💾 저장</button>
        </div>
    </div>

    <div class="stats">
        <span>전체 필드 선수: <span id="fieldCount">0</span>/33명</span>
    </div>

    <div class="fields-container">
        // ...existing fields container code...
    </div>

    <div class="bench-area">
        <div class="controls" style="text-align: center; margin-bottom: 15px;">
            <!-- 선수 추가 UI -->
            <div class="add-player-controls">
                <input type="text" id="newPlayerName" placeholder="새 선수 이름" style="width: 150px;">
                <select id="newPlayerGrade">
                    <option value="T3">T3</option>
                    <option value="T4">T4</option>
                </select>
                <button onclick="addNewPlayer()">➕ 선수 추가</button>
            </div>
            <!-- 검색 UI -->
            <div>
                <input type="text" id="playerSearch" placeholder="선수 검색..." style="width: 200px;">
                <button onclick="searchPlayer()">🔍 검색</button>
                <button onclick="clearSearch()">❌ 초기화</button>
            </div>
        </div>
        // ...existing bench-container...
    </div>

    <script>
        // ...existing code until enableDropZones...

        function enableDropZones() {
            document.querySelectorAll('.formation-field .line').forEach(zone => {
                const emptyZone = zone.querySelector('.empty-zone');
                const field = zone.closest('.formation-field');
                
                Sortable.create(zone, {
                    group: 'shared',
                    animation: 200,
                    onAdd: function(evt) {
                        // 먼저 필드 제한 확인
                        if (!checkFieldLimit(field)) {
                            const player = evt.item;
                            const grade = player.dataset.grade;
                            const targetBench = grade === 'T3' ? 
                                document.querySelector('#t3Bench .players-container') : 
                                document.querySelector('#t4Bench .players-container');
                            targetBench.appendChild(player);
                            return;
                        }

                        if (emptyZone) emptyZone.style.display = 'none';
                        limitPlayers(zone);
                        updateStats();
                    },
                    onRemove: function() {
                        if (zone.querySelectorAll('.player').length === 0 && emptyZone) {
                            emptyZone.style.display = 'block';
                        }
                        updateStats();
                    }
                });
            });

            // ...existing bench containers code...
        }

        function checkFieldLimit(field) {
            const playerCount = field.querySelectorAll('.player').length;
            if (playerCount >= 11) {
                alert('한 팀당 최대 11명까지만 배치할 수 있습니다.');
                return false;
            }
            return true;
        }

        function addNewPlayer() {
            const name = document.getElementById('newPlayerName').value.trim();
            const grade = document.getElementById('newPlayerGrade').value;
            
            if (!name) {
                alert('선수 이름을 입력해주세요.');
                return;
            }

            // 중복 이름 체크
            const isDuplicate = players.some(p => p.nick.toLowerCase() === name.toLowerCase());
            if (isDuplicate) {
                alert('이미 존재하는 선수 이름입니다.');
                return;
            }

            // 새 선수 객체 생성
            const div = document.createElement('div');
            div.className = `player ${grade.toLowerCase()}`;
            div.textContent = name;
            div.dataset.nick = name;
            div.dataset.grade = grade;

            const newPlayer = {
                nick: name,
                grade: grade,
                element: div
            };

            // players 배열에 추가
            players.push(newPlayer);

            // UI 갱신
            renderBench();
            
            // 입력 필드 초기화
            document.getElementById('newPlayerName').value = '';
        }

        function updateStats() {
            // ...existing updateStats code...

            // 각 필드별 카운트 업데이트
            ['field1', 'field2', 'field3'].forEach(fieldId => {
                const count = document.querySelector(`#${fieldId}`).querySelectorAll('.player').length;
                document.querySelector(`#${fieldId}Count`).textContent = `(${count}/11명)`;
            });
        }

        // ...existing event listeners...

        // 선수 추가 Enter 키 이벤트
        document.getElementById('newPlayerName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addNewPlayer();
            }
        });
    </script>
</body>
</html>
